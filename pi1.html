<html>
    <script>
        const LAYERS = ['floor', 'glass', 'bath', 'base'] 
        const LAYERS_IMAGE_DATA = new Map()

        let context

        function onClick(element, name) 
        {
            modifyColor(toRGB(element.style.backgroundColor), LAYERS_IMAGE_DATA.get(name))
        }

        function modifyColor(rgbval, imageData)
        {
            let pixels = imageData.data
            for(let i=0; i<pixels.length; i+=4)
            {
                pixels[i] = multiplyColor(pixels[i], rgbval.r)
                pixels[i+1] = multiplyColor(pixels[i+1], rgbval.g)
                pixels[i+2] = multiplyColor(pixels[i+2], rgbval.b)
            }
            drawCombinedImage()
        }

        window.onload = ()=>
        {
            const folder = 'assets/pi/'
            const extension = '.png'
            for (let i=0; i<LAYERS.length; i++)
                requestServer(folder+LAYERS[i]+extension, i)
        }

        function requestServer(path, index)
        {
            let reader = new XMLHttpRequest()
            reader.open('GET', path)
            reader.onreadystatechange = () =>
            {
                if (reader.readyState == 4 && reader.status == 200)
                    onImageDownload(reader.response, index)
            }
            reader.responseType = 'blob'
            reader.send()
        }

        function onImageDownload(blob, index)
        {
            let bloburl = URL.createObjectURL(blob)
            let img = new Image()
            img.src = bloburl
            img.onload = () => 
            {
                URL.revokeObjectURL(bloburl)
                onImageLoad(img, index)
            };
        }

        function onImageLoad(img, index)
        {
            LAYERS_IMAGE_DATA.set(LAYERS[index], getImageDataFromImage(img))
            if (LAYERS.length == LAYERS_IMAGE_DATA.size)
            {    
                let canvas = document.getElementById("canvas")
                context = canvas.getContext('2d')
                canvas.width = img.width
                canvas.height = img.height
                drawCombinedImage(context)
            }
        }

        function getImageDataFromImage(img)
        {
            let canvas = document.createElement('canvas')
            let ctxt = canvas.getContext('2d')
            canvas.width = img.width
            canvas.height = img.height
            ctxt.drawImage(img, 0, 0)
            return ctxt.getImageData(0, 0, img.width, img.height)
        }

        function drawCombinedImage()
        {
            let firstImageData = LAYERS_IMAGE_DATA.get(LAYERS[0])
            let width = firstImageData.width
            let height = firstImageData.height
            let imageSize = firstImageData.data.length
            let finalImage = new Uint8ClampedArray(imageSize)
            for (let i=0; i<imageSize; i+=4)
            {
                let finalR = 255
                let finalG = 255
                let finalB = 255
                for (let j=0; j<LAYERS_IMAGE_DATA.size; j++)
                {
                    let imageData = LAYERS_IMAGE_DATA.get(LAYERS[j])
                    let a = imageData.data[i + 3]
                    let r = multiplyColor(imageData.data[i], a)
                    let g = multiplyColor(imageData.data[i + 1], a)
                    let b = multiplyColor(imageData.data[i + 2], a)  
                    if (r > 0)
                        finalR = multiplyColor(finalR, r)
                    if (g > 0) 
                        finalG = multiplyColor(finalG, g)
                    if (b > 0)
                        finalB = multiplyColor(finalB, b)
                    if (a == 255)
                        break;
                }
                finalImage[i] = finalR
                finalImage[i + 1] = finalG
                finalImage[i + 2] = finalB
                finalImage[i + 3] = 255
            }
            context.putImageData(toImagedata(finalImage, width, height), 0, 0)
        }

        function toImagedata(data, width, height)
        {
            return new ImageData(data, width, height)
        }

        function toRGB(str)
        {
            let match = str.match(/rgba?\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3})\)?(?:, ?(\d(?:\.\d?))\))?/)
            return match ? {r:match[1], g:match[2], b:match[3]} : {r:0, g:0, b:0}
        }

        function multiplyColor(c1, c2)
        {   
            c1 /= 255
            c2 /= 255
            return c1 * c2 * 255
        }
    </script>
    <style>
            canvas
            {
                width: 100%;
                height: 100%;
            }

            div#list-color
            {
                position: absolute;
                top: 2%;
                left: 2%;
                width: 25%;
                height: 20%;
                padding: 20px;
                max-width: 400px;
                max-height: 100px;
                background-color: rgba(0, 0, 0, 0.4);
                border-radius: 3ch;
                display: flex;
                overflow-x: auto;
            }

            div.list-item-color
            {
                position: relative;
                min-width: 80px;
                width: 25%;
                margin-right: 10%;
                height: 90%;
                border-radius: 3ch;
            }

            p
            {
                display: block;
                width: 2%;
                margin: auto;
                position: relative;
                top: 35%;
                left: -20%;
            }
    </style>
    <body>
        <canvas id="canvas"></canvas>
        <div id="list-color">
            <div onclick="onClick(this, 'base')" class="list-item-color" style = "background-color: #FEA47F;"><p>base</p></div>
            <div onclick="onClick(this, 'bath')" class="list-item-color" style = "background-color: #EAB543;"><p>bath</p></div>
            <div onclick="onClick(this, 'floor')" class="list-item-color" style = "background-color: #55E6C1;"><p>floor</p></div>
            <div onclick="onClick(this, 'glass')" class="list-item-color" style = "background-color: #F97F51;"><p>glass</p></div>
        </div>
    </body>
</html>